rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Puzzles collection
    match /puzzles/{puzzleId} {
      // Anyone can read puzzles
      allow read: if true;

      // Only authenticated users can create puzzles
      allow create: if request.auth != null
        && request.resource.data.creatorId == request.auth.uid;

      // Only the creator can update their own puzzles
      allow update: if request.auth != null
        && resource.data.creatorId == request.auth.uid;

      // Only the creator can delete their own puzzles
      allow delete: if request.auth != null
        && resource.data.creatorId == request.auth.uid;
    }

    // Game states collection
    match /gameStates/{gameStateId} {
      // Users can only read their own game states
      allow read: if request.auth != null
        && resource.data.userId == request.auth.uid;

      // Users can only create game states for themselves
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;

      // Users can only update their own game states
      allow update: if request.auth != null
        && resource.data.userId == request.auth.uid;

      // Users can only delete their own game states
      allow delete: if request.auth != null
        && resource.data.userId == request.auth.uid;
    }

    // Puzzle player stats collection
    match /puzzlePlayerStats/{statId} {
      // Allow users to create and update their own stats documents
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;

      allow update: if request.auth != null
        && resource.data.userId == request.auth.uid;

      // Allow puzzle authors to read stats for their puzzles
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/puzzles/$(resource.data.puzzleId)) &&
        get(/databases/$(database)/documents/puzzles/$(resource.data.puzzleId)).data.creatorId == request.auth.uid;
    }
  }
}
